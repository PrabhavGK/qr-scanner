<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Ticket Scanner</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:0;background:#f6f7fb;color:#111;text-align:center}
    header{padding:12px 16px;background:#0b63d6;color:white}
    #reader{width:90%;max-width:480px;margin:20px auto;border:2px solid #ccc;border-radius:8px}
    .controls{margin:15px}
    button{padding:10px 16px;border-radius:8px;border:none;background:#0b63d6;color:#fff;font-size:15px;cursor:pointer}
    .status{margin-top:12px;padding:10px;border-radius:8px}
    .ok{background:#e6ffef;border:1px solid #0a8a4b;color:#0a8a4b}
    .fail{background:#fff0f0;border:1px solid #d64545;color:#a00}
    .info{background:#eef3ff;border:1px solid #6b8ef1;color:#1133aa}
  </style>

  <!-- ✅ Load the html5-qrcode library BEFORE anything else -->
  <script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
</head>

<body>
  <header><strong>QR Ticket Scanner</strong></header>
  <div id="reader"></div>
  <div class="controls">
    <button id="startBtn">Start Camera</button>
    <button id="stopBtn">Stop Camera</button>
  </div>
  <div id="resultArea"></div>

  <!-- ✅ Custom logic AFTER library -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const API_CHECK_URL = "https://script.google.com/macros/s/AKfycbxrPVM9DWRQcC9q5RQc_9ETR--4UNR1cltedn04Q4PC3EUt0txHo-jpPutaJCvygIcm/exec";
    const API_MARK_URL  = "https://script.google.com/macros/s/AKfycbxrPVM9DWRQcC9q5RQc_9ETR--4UNR1cltedn04Q4PC3EUt0txHo-jpPutaJCvygIcm/exec";

    const resultArea = document.getElementById("resultArea");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    let scanner = null;
    let scanning = false;

    function logResult(msg, cls){
      resultArea.innerHTML = `<div class=\"status ${cls}\">${msg}</div>`;
    }

    async function checkTicket(id){
      try{
        const res = await fetch(API_CHECK_URL + '?ticket=' + encodeURIComponent(id));
        return await res.json();
      }catch(e){return {error:true};}
    }
    async function markTicket(id){
      try{
        const res = await fetch(API_MARK_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ticket:id})
        });
        return await res.json();
      }catch(e){return {error:true};}
    }

    async function onScan(decodedText){
      if(!scanning) return;
      scanning=false;
      await scanner.pause(true);
      const id = decodedText.trim();
      logResult(`Scanned: <strong>${id}</strong><br/>Checking...`, 'info');
      const info = await checkTicket(id);
      if(info.error) logResult('Network error.', 'fail');
      else if(!info.exists) logResult(`❌ Ticket <strong>${id}</strong> not found.`, 'fail');
      else if(info.used) logResult(`⚠️ Ticket <strong>${id}</strong> already used.`, 'fail');
      else{
        const mark = await markTicket(id);
        if(mark.ok) logResult(`✅ Valid — Ticket <strong>${id}</strong> marked as USED.`, 'ok');
        else logResult('Error marking ticket.', 'fail');
      }
      setTimeout(()=>{scanner.resume(); scanning=true;},1200);
    }

    startBtn.addEventListener("click", async () => {
      try{
        // Force permission popup
        const stream = await navigator.mediaDevices.getUserMedia({ video:true });
        stream.getTracks().forEach(t=>t.stop());

        const devices = await Html5Qrcode.getCameras();
        if(!devices || devices.length===0){ logResult('❌ No camera found.','fail'); return; }
        const camId = devices.find(d=>d.label.toLowerCase().includes('back'))?.id || devices[0].id;

        scanner = new Html5Qrcode("reader");
        await scanner.start({deviceId:{exact:camId}}, {fps:10, qrbox:250}, onScan);
        scanning=true;
        logResult('Camera started — scanning...','info');
      }catch(err){
        console.error(err);
        logResult('⚠️ Camera error: '+err.message,'fail');
      }
    });

    stopBtn.addEventListener("click", async ()=>{
      if(scanner){
        await scanner.stop();
        scanner.clear();
        scanner=null;
        scanning=false;
        logResult('Camera stopped.','info');
      }
    });
  });
  </script>
</body>
</html>
